<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pixel Farm</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #a8d0a5;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script>
    const config = {
      type: Phaser.AUTO,
      width: window.innerWidth,
      height: window.innerHeight,
      backgroundColor: '#a8d0a5',
      physics: {
        default: 'arcade',
      },
      scene: {
        preload: preload,
        create: create,
        update: update,
      },
      pixelArt: true,
    };

    let game = new Phaser.Game(config);
    let animals = [];
    let tiles = [];
    let lastGeneratedX = 0;

    function createColoredRect(scene, color, width = 32, height = 32) {
      const gfx = scene.make.graphics({ x: 0, y: 0, add: false });
      gfx.fillStyle(color, 1);
      gfx.fillRect(0, 0, width, height);
      const texKey = 'rect-' + color + '-' + width + 'x' + height;
      gfx.generateTexture(texKey, width, height);
      gfx.destroy();
      return texKey;
    }

    function preload() {
      // Genera rettangoli come placeholder per oggetti
      this.registry.set('texKeys', {
        ground: createColoredRect(this, 0x556b2f, 64, 64),
        tree: createColoredRect(this, 0x228b22, 24, 48),
        house: createColoredRect(this, 0x8b0000, 32, 32),
        chicken: createColoredRect(this, 0xffff00, 16, 16),
      });
    }

    function create() {
      this.cameras.main.setBounds(0, 0, Number.MAX_SAFE_INTEGER, config.height);
      this.physics.world.setBounds(0, 0, Number.MAX_SAFE_INTEGER, config.height);
      this.cameras.main.startFollow({ x: 0, y: config.height / 2 }, true, 0.05, 0.05);

      generateChunk(this, 0);
    }

    function generateChunk(scene, xStart) {
      const tileWidth = 64;
      const chunkSize = 20;
      const tex = scene.registry.get('texKeys');

      for (let i = 0; i < chunkSize; i++) {
        const x = xStart + i * tileWidth;
        const y = config.height - 64;
        const ground = scene.add.image(x, y, tex.ground).setOrigin(0);
        tiles.push(ground);

        const rand = Math.random();
        if (rand < 0.1) {
          scene.add.image(x + 16, y - 48, tex.tree);
        } else if (rand < 0.15) {
          scene.add.image(x + 16, y - 32, tex.house);
        } else if (rand < 0.25) {
          const chicken = scene.physics.add.image(x + 16, y - 16, tex.chicken);
          chicken.setVelocityX(Phaser.Math.Between(-10, 10));
          animals.push(chicken);
        }
      }

      lastGeneratedX = xStart + chunkSize * tileWidth;
    }

    function update(time, delta) {
      const cam = this.cameras.main;
      cam.scrollX += 0.05;

      if (cam.scrollX + config.width > lastGeneratedX - 500) {
        generateChunk(this, lastGeneratedX);
      }

      animals.forEach(a => {
        if (a.x < 0 || a.x > lastGeneratedX) {
          a.setVelocityX(-a.body.velocity.x);
        }
      });
    }
  </script>
</body>
</html>
